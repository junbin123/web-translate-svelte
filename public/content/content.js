!function(){"use strict";const t=t=>t.trim().replace(/[\n\r]/g,"").replace(/\s+/g," "),e=({list:t=[],length:e=1e3})=>{let n=[],o="",r=0;for(const[s,c]of t.entries())if(o+=c,r=s,o.length>e){r=s-1,n=t.slice(0,s);break}return r===t.length-1&&(n=t),{targetList:n,endIndex:r}},n=t=>t.parentElement.removeChild(t),o=t=>{const e=[];return function t(n){const o=Array.from(n?.children||[]).filter((t=>"SCRIPT"!==t.nodeName)),r=(({element:t})=>{if(t.textContent.replace(/\s+/g,"").length<4)return!1;const e=["SCRIPT","CODE","NOSCRIPT","STYLE"];return!e.includes(t.nodeName)&&!Array.from(t.childNodes).every((t=>e.includes(t.nodeName)))})({element:n});if(o.length>0&&r){Array.from(n.childNodes).filter((t=>t.textContent.replace(/\s+/g,"")&&"SCRIPT"!==t.nodeName)).map((t=>t.nodeName)).some((t=>"#text"===t))?e.push(n):Array.from(n?.children||[]).forEach(t)}else r&&e.push(n)}(t),e};console.log("我是content.js");let r=[],s=[],c=0,i=[],l="en2zh";let a=!1,u=`${document.location.origin}${document.location.pathname}`;async function d({originDomList:e=[]}){if(a=!0,console.log("doTransProcess",e),0===e.length)return[];const o=[],r=[];e.forEach(((e,n)=>{const s=t(e.textContent),c=(({parentDom:t,childText:e})=>{const n=document.createElement("div");return n.innerText=e,n.setAttribute("class","content-class"),t.appendChild(n),n})({parentDom:e,childText:s});o.push(s),r.push(c)})),console.log(1);try{const{target:t}=await(async({source:t=[],transType:e="en2zh"})=>{const n={source:t,trans_type:e,detect:!0},o={headers:{"content-type":"application/json","x-authorization":"token oo00trx4oclspt3nqhfc"},body:JSON.stringify(n),method:"POST"};try{const t=await fetch("https://api.interpreter.caiyunai.com/v1/translator",o).then((t=>t.json()));return console.log("彩云结果",t),t}catch(t){return console.log("彩云报错",t),t}})({source:o,transType:l});if(console.log(2,t),!t||0===t.length)return r.forEach((t=>{n(t)})),{transDomList:[]};r.forEach(((e,n)=>{e.innerText=t[n],e.setAttribute("class","content-class-complete")}))}catch(t){return console.log(t),r.forEach((t=>{n(t)})),{transDomList:[]}}return a=!1,{transDomList:r}}chrome.runtime.onMessage.addListener((async(a,m,h)=>{console.log("来自popup的数据",a);const{action:g=""}=a;if("noTrans"===g)return i.forEach((t=>{n(t)})),c=0,i.length=0,void h({status:"done"});if(l=`${a.source}2${a.target}`,console.log("点击",a,{transIndex:c}),u!==`${document.location.origin}${document.location.pathname}`&&(h({canTrans:!1,currentUrl:u}),c=0,u=`${document.location.origin}${document.location.pathname}`),c>0)return void h({canTrans:!1,currentUrl:u});h({canTrans:!0,currentUrl:u}),r=o(document.body),s=r.map((e=>t(e.textContent)));let p=0;s.forEach((t=>{p+=t.length})),console.log("--------number",p),console.log("nodeList",r),console.log("textList",s);const{targetList:f,endIndex:T}=e({list:s,length:3e3});console.log("");try{const{transDomList:t}=await d({originDomList:r.slice(0,T+1)});i=t,c=T}catch(t){console.log(t)}})),window.addEventListener("scroll",((t,e=500)=>{let n=null;return function(){n||(n=setTimeout((()=>{t.apply(this,arguments),n=null}),e))}})((async function(t){if(0===c||c===r.length-1||a)return;const n=r[c+1],{relativeWindow:o="",isVisible:l=!1}=(t=>{const e=window.scrollY,n=document.documentElement.clientHeight,o=t.offsetTop,r=t.offsetHeight;let s="";return s=o+r<e?"outsideTop":o<e?"intersectTop":o+r<e+n?"inside":o<e+n?"intersectBottom":"outsideBottom","FIGCAPTION"===t.nodeName&&(s="unknown"),{relativeWindow:s,isVisible:["intersectTop","inside","intersectBottom"].includes(s)}})(n);if(["intersectBottom","outsideBottom"].includes(o))return;a=!0;const u=s.slice(c+1),{targetList:m,endIndex:h}=e({list:u,length:3e3});try{const{transDomList:t}=await d({originDomList:r.slice(c+1,c+2+h)});i=[...i,...t],c+=h+1}catch(t){console.log(t)}a=!1})))}();
